name: CI

on:
  push:
  pull_request:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: pip install uv
      - name: Sync dependencies
        run: uv sync --frozen
      - name: Ruff lint
        run: uv run ruff check .
      - name: Mypy type-check
        run: uv run mypy app sdk
      - name: Unit tests (security/audit)
        run: uv run pytest -m "not e2e"

  e2e:
    if: ${{ env.RUN_OPENAI_E2E == '1' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: pip install uv
      - name: Sync dependencies
        run: uv sync --frozen
      - name: Run e2e OpenAI/RAG tests (requires API_BASE/API_KEY/Kb)
        env:
          RUN_OPENAI_E2E: ${{ env.RUN_OPENAI_E2E }}
          API_BASE: ${{ env.API_BASE }}
          API_KEY: ${{ env.API_KEY }}
          KB_ID: ${{ env.KB_ID }}
        run: uv run pytest -m "e2e" tests/test_e2e_openai.py tests/test_e2e_health.py

  es-e2e:
    if: ${{ env.RUN_ES_E2E == '1' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: pip install uv
      - name: Sync dependencies
        run: uv sync --frozen
      - name: Run ES/OpenSearch e2e tests
        env:
          RUN_ES_E2E: ${{ env.RUN_ES_E2E }}
          API_BASE: ${{ env.API_BASE }}
          API_KEY: ${{ env.API_KEY }}
          KB_ID: ${{ env.KB_ID }}
          ES_HOSTS: ${{ env.ES_HOSTS }}
          ES_USERNAME: ${{ env.ES_USERNAME }}
          ES_PASSWORD: ${{ env.ES_PASSWORD }}
        run: uv run pytest -m "e2e" tests/test_opensearch_e2e.py
