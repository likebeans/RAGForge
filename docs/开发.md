# RAG Pipeline Service å¼€å‘æ–‡æ¡£

> ä¼ä¸šçº§çŸ¥è¯†åº“æ£€ç´¢æœåŠ¡ (KB-as-a-Service)

---

## 0. é¡¹ç›®å®šä½

### æ ¸å¿ƒç†å¿µ

**åšä¸€ä¸ªä¼ä¸šçº§ã€ŒçŸ¥è¯†åº“æ£€ç´¢æœåŠ¡ã€(KB-as-a-Service)**

| èŒè´£èŒƒå›´ | è¯´æ˜ |
|---------|------|
| è´Ÿè´£ | æ–‡æ¡£æ‘„å– â†’ çŸ¥è¯†åº“æ„å»º â†’ æ£€ç´¢ / RAG èƒ½åŠ› |
| è´Ÿè´£ | ç®—æ³• Pipeline å¯æ’æ‹”ã€å¯é…ç½® |
| è´Ÿè´£ | å¤šç§Ÿæˆ· & æƒé™æ§åˆ¶ |
| ä¸è´Ÿè´£ | å¯¹è¯ç•Œé¢ã€æ™ºèƒ½ä½“ç¼–æ’ã€å·¥ä½œæµè®¾è®¡ |

å°†æ¥ä»»ä½•æ™ºèƒ½ä½“å¹³å°ï¼ˆFastGPTã€agent-service-toolkitã€è‡ªç ” Agent å¹³å°ï¼‰éƒ½å¯ä»¥é€šè¿‡ API/SDK è°ƒç”¨æœ¬æœåŠ¡ã€‚

### ä¸ç«å“å¯¹æ¯”

| é¡¹ç›® | å®šä½ | ç‰¹ç‚¹ | æˆ‘ä»¬çš„å·®å¼‚ |
|------|------|------|-----------|
| [DeepSearcher][1] | ç ”ç©¶å‹æ·±åº¦æœç´¢ | å¤šå‘é‡åº“ã€æ£€ç´¢+è¯„ä¼°+æŠ¥å‘Š | åé‡ï¼Œæˆ‘ä»¬æ›´è½»é‡èšç„¦ |
| [FastGPT][2] | AI Agent å¹³å° | çŸ¥è¯†åº“+å·¥ä½œæµ+åº”ç”¨ç®¡ç† | æˆ‘ä»¬åªåšçŸ¥è¯†åº“å±‚ |
| [R2R][3] | RAG as a Service | REST APIã€æ··åˆæœç´¢ã€çŸ¥è¯†å›¾è°± | å‚è€ƒå…¶ API è®¾è®¡ |
| [agent-service-toolkit][4] | Agent æœåŠ¡æ¨¡æ¿ | LangGraph + FastAPI + UI | å‚è€ƒå…¶æœåŠ¡æ¶æ„ |

**æœ¬é¡¹ç›®å®šä½**ï¼šR2R çš„è½»é‡ç‰ˆ + LlamaIndex ç®—æ³•å†…æ ¸ + ä¼ä¸šçº§æƒé™æ§åˆ¶

> é¢å‘å¼€å‘è€…çš„ä¼ä¸šçŸ¥è¯†åº“ RAG å¼•æ“ï¼Œä¸Šå±‚åº”ç”¨åªéœ€ HTTP è¯·æ±‚å³å¯è·å¾—æ£€ç´¢èƒ½åŠ›ã€‚

---

## 1. æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸Šå±‚è°ƒç”¨è€… (Agent å¹³å°)                        â”‚
â”‚  LangGraph Agent / FastGPT / è‡ªç ”æ™ºèƒ½ä½“ / ä¸šåŠ¡ç³»ç»Ÿåç«¯            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP API / Python SDK
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  çŸ¥è¯†åº“æ ¸å¿ƒæœåŠ¡ (æœ¬é¡¹ç›®)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   API å±‚     â”‚  â”‚  æƒé™æ§åˆ¶    â”‚  â”‚   ç›‘æ§ & æ—¥å¿—        â”‚   â”‚
â”‚  â”‚ FastAPI      â”‚  â”‚ RBAC/ç§Ÿæˆ·   â”‚  â”‚   Trace/Metrics     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Pipeline å¼•æ“ (åŸºäº LlamaIndex)              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Ingestion Pipeline  â”‚  â”‚    Query Pipeline       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ Loaderâ†’Chunkerâ†’     â”‚  â”‚ Rewriteâ†’Retrieveâ†’       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ Embedderâ†’Indexer    â”‚  â”‚ Rerankâ†’ContextBuildâ†’Gen â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   ç®—å­æ³¨å†Œè¡¨ (Operators)                  â”‚   â”‚
â”‚  â”‚  Chunkers | Indexers | Retrievers | Rerankers | Embeddersâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å­˜å‚¨å±‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ–‡æ¡£å­˜å‚¨     â”‚  â”‚   å‘é‡åº“     â”‚  â”‚   å€’æ’ç´¢å¼•           â”‚   â”‚
â”‚  â”‚ Postgres/S3  â”‚  â”‚ Milvus/Qdrantâ”‚  â”‚  ES/OpenSearch       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—è¯´æ˜

| æ¨¡å— | èŒè´£ |
|------|------|
| **KB ç®¡ç†** | å¤šçŸ¥è¯†åº“ã€å¤šç§Ÿæˆ·éš”ç¦» |
| **æƒé™æ§åˆ¶** | ç§Ÿæˆ·éš”ç¦»ã€API Key é‰´æƒã€RBAC è§’è‰²æƒé™ |
| **Ingestion Pipeline** | æ–‡æ¡£ â†’ è§£æ â†’ åˆ†å— â†’ å‘é‡åŒ– â†’ å»ºç´¢å¼• |
| **Query Pipeline** | Query â†’ æ£€ç´¢ â†’ é‡æ’ â†’ ä¸Šä¸‹æ–‡æ„å»º â†’ (å¯é€‰)ç”Ÿæˆ |
| **ç®—å­æ³¨å†Œè¡¨** | å¯æ’æ‹”ç®—æ³•ç»„ä»¶ï¼Œæ”¯æŒè‡ªå®šä¹‰æ‰©å±• |
| **ç›‘æ§æ—¥å¿—** | è°ƒç”¨è¿½è¸ªã€å¬å›æ–‡æœ¬è®°å½•ã€è€—æ—¶ç»Ÿè®¡ |

**å½“å‰å¼€å‘é‡ç‚¹**ï¼šçŸ¥è¯†åº“æ ¸å¿ƒæœåŠ¡å±‚ï¼Œåšæˆç‹¬ç«‹ HTTP æœåŠ¡ã€‚

---

## 2. æƒé™æ§åˆ¶è®¾è®¡

ä¼ä¸šçº§åº”ç”¨çš„æ ¸å¿ƒéœ€æ±‚ï¼Œé‡‡ç”¨å¤šå±‚æƒé™æ¨¡å‹ã€‚å‚è€ƒ [Azure å¤šç§Ÿæˆ· RAG å®‰å…¨è®¾è®¡](https://learn.microsoft.com/zh-cn/azure/architecture/ai-ml/guide/secure-multitenant-rag) å’Œ [Zilliz RBAC æœ€ä½³å®è·µ](https://zilliz.com.cn/blog/zillizcloud-rbac-apply)ã€‚

### 2.1 æƒé™å±‚çº§ï¼ˆå››å±‚æ¨¡å‹ï¼‰

```
Tenant (ç§Ÿæˆ·/ä¼ä¸š)
  â”œâ”€â”€ User (ç”¨æˆ·)
  â”‚     â””â”€â”€ Role (è§’è‰²) â†’ Permission (æƒé™)
  â”œâ”€â”€ API Key (æœåŠ¡è°ƒç”¨å‡­è¯ï¼Œå¯é™å®šæƒé™èŒƒå›´)
  â””â”€â”€ KnowledgeBase (çŸ¥è¯†åº“)
        â””â”€â”€ Document (æ–‡æ¡£)
              â””â”€â”€ ACL (æ–‡æ¡£çº§è®¿é—®æ§åˆ¶åˆ—è¡¨)
```

**å…³é”®è®¾è®¡**ï¼šæ”¯æŒåˆ°**æ–‡æ¡£çº§åˆ«**çš„ç»†ç²’åº¦æƒé™æ§åˆ¶ (ACL)ã€‚

### 2.2 è®¤è¯æ–¹å¼

| æ–¹å¼ | é€‚ç”¨åœºæ™¯ | è¯´æ˜ |
|------|----------|------|
| **API Key** | æœåŠ¡é—´è°ƒç”¨ | æ¯ä¸ªç§Ÿæˆ·å¯åˆ›å»ºå¤šä¸ªï¼Œæ”¯æŒæƒé™èŒƒå›´é™åˆ¶ï¼ˆå¦‚åªè¯»ã€æŒ‡å®šçŸ¥è¯†åº“ï¼‰|
| **JWT Token** | ç”¨æˆ·ç™»å½• | æ”¯æŒ SSO é›†æˆï¼Œå¯æ‰©å±• OAuth2/OIDC |
| **å†…éƒ¨è°ƒç”¨** | å¾®æœåŠ¡é€šä¿¡ | åŸºäº Service Accountï¼Œä¿¡ä»»å†…ç½‘ |

### 2.3 RBAC + è‡ªå®šä¹‰è§’è‰²

**å†…ç½®è§’è‰²**ï¼š

```yaml
builtin_roles:
  - name: tenant_admin
    description: ç§Ÿæˆ·ç®¡ç†å‘˜ï¼Œå…¨éƒ¨æƒé™
    permissions: ["*"]
  
  - name: kb_admin
    description: çŸ¥è¯†åº“ç®¡ç†å‘˜
    permissions: [kb:*, document:*, query:*]
  
  - name: editor
    description: å†…å®¹ç¼–è¾‘
    permissions: [document:create, document:update, document:delete, query:*]
  
  - name: reader
    description: åªè¯»ç”¨æˆ·
    permissions: [query:execute]
```

**è‡ªå®šä¹‰è§’è‰²**ï¼ˆæ»¡è¶³å¤æ‚ä¸šåŠ¡éœ€æ±‚ï¼‰ï¼š

```yaml
custom_roles:
  # è´¢åŠ¡éƒ¨é—¨ - åªèƒ½è®¿é—®è´¢åŠ¡ç›¸å…³çŸ¥è¯†åº“
  - name: finance_reader
    scope:
      knowledge_bases: [kb_finance, kb_policy]
    permissions: [query:execute]
  
  # åŒ»ç–—åœºæ™¯ - æ‚£è€…åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
  - name: patient
    scope:
      documents:
        filter: "metadata.patient_id == user.id"
    permissions: [query:execute]
  
  # å®¡è®¡å‘˜ - å¯æŸ¥çœ‹æ‰€æœ‰æ•°æ®ä½†ä¸èƒ½ä¿®æ”¹
  - name: auditor
    scope:
      knowledge_bases: ["*"]
    permissions: [query:execute, document:read, audit:read]
```

### 2.4 æ–‡æ¡£çº§ ACL æƒé™æ§åˆ¶

æ”¯æŒåŸºäº**æ ‡ç­¾/å…ƒæ•°æ®**çš„æ–‡æ¡£è®¿é—®æ§åˆ¶ï¼š

```python
# æ–‡æ¡£å…ƒæ•°æ®ä¸­çš„ ACL å­—æ®µ
document = {
    "id": "doc-001",
    "content": "...",
    "metadata": {
        "title": "Q3é”€å”®æ”¿ç­–",
        "department": "sales",           # éƒ¨é—¨æ ‡ç­¾
        "sensitivity": "internal",       # æ•æ„Ÿåº¦: public/internal/confidential/secret
        "acl": {
            "allow_users": ["user_001", "user_002"],
            "allow_roles": ["sales_manager", "executive"],
            "allow_groups": ["sales_team"],
            "deny_users": [],
            "deny_roles": [],
            "deny_groups": []
        }
    }
}
```

**æ•æ„Ÿåº¦çº§åˆ«**ï¼š

| çº§åˆ« | è¯´æ˜ | è®¿é—®èŒƒå›´ |
|------|------|----------|
| `public` | å…¬å¼€ | ç§Ÿæˆ·å†…æ‰€æœ‰ç”¨æˆ· |
| `internal` | å†…éƒ¨ | æŒ‡å®šéƒ¨é—¨/è§’è‰² |
| `confidential` | æœºå¯† | æŒ‡å®šç”¨æˆ·/ç»„ |
| `secret` | ç»å¯† | ä»…ç®¡ç†å‘˜ |

### 2.5 æ£€ç´¢æ—¶å®‰å…¨ç­›é€‰ (Security Trimming)

**æ ¸å¿ƒåŸåˆ™**ï¼šç”¨æˆ·æ£€ç´¢æ—¶ï¼Œè‡ªåŠ¨è¿‡æ»¤æ— æƒè®¿é—®çš„æ–‡æ¡£ã€‚

```python
# æ£€ç´¢æ—¶è‡ªåŠ¨æ³¨å…¥æƒé™è¿‡æ»¤
async def query_with_security_trimming(
    query: str,
    kb_ids: list[str],
    user: User,
    top_k: int = 10
) -> list[Chunk]:
    # 1. æ„å»ºæƒé™è¿‡æ»¤æ¡ä»¶
    acl_filter = build_acl_filter(user)
    
    # 2. å‘é‡æ£€ç´¢æ—¶æ³¨å…¥è¿‡æ»¤æ¡ä»¶
    results = await vector_store.search(
        query_embedding=embed(query),
        filter={
            "kb_id": {"$in": kb_ids},
            "$and": [
                {"tenant_id": user.tenant_id},
                acl_filter  # ACL è¿‡æ»¤
            ]
        },
        top_k=top_k * 2  # å¤šå¬å›ï¼Œç­›é€‰åå¯èƒ½å‡å°‘
    )
    
    # 3. äºŒæ¬¡å®‰å…¨ä¿®æ•´ï¼ˆå¤æ‚è§„åˆ™ï¼‰
    trimmed = security_trim(results, user)
    
    return trimmed[:top_k]

def build_acl_filter(user: User) -> dict:
    """æ„å»º ACL è¿‡æ»¤æ¡ä»¶ï¼ˆç¤ºä¾‹ä¸º mongo-like è¯­æ³•ï¼Œæ ¹æ®å‘é‡åº“è°ƒæ•´ï¼‰"""
    allow = {
        "$or": [
            {"metadata.sensitivity": "public"},
            {
                "$and": [
                    {"metadata.sensitivity": "internal"},
                    {"metadata.department": {"$in": user.departments}},
                ]
            },
            {
                "$and": [
                    {"metadata.sensitivity": {"$in": ["confidential", "secret"]}},
                    {
                        "$or": [
                            {"metadata.acl.allow_users": {"$in": [user.id]}},
                            {"metadata.acl.allow_roles": {"$in": user.roles}},
                            {"metadata.acl.allow_groups": {"$in": user.groups}},
                        ]
                    }
                ]
            },
        ]
    }

    deny = {
        "$and": [
            {"metadata.acl.deny_users": {"$nin": [user.id]}},
            {"metadata.acl.deny_roles": {"$nin": user.roles}},
            {"metadata.acl.deny_groups": {"$nin": user.groups}},
        ]
    }

    return {"$and": [allow, deny]}
```

> ä¸åŒå‘é‡åº“è¿‡æ»¤è¯­æ³•ï¼ˆQdrant/Milvus/ESï¼‰ä¸åŒï¼Œæ­¤å¤„ä¸º mongo-like ç¤ºä¾‹ï¼Œå®é™…å®ç°è¯·ç”¨ must/must_notï¼ˆæˆ–ç­‰ä»·çš„ `$in`/`$nin`ï¼‰è¡¨è¾¾ï¼Œé¿å… `$not`ã€‚

### 2.6 å¤šç§Ÿæˆ·å­˜å‚¨éš”ç¦»ç­–ç•¥

æ ¹æ®å®¢æˆ·è§„æ¨¡é€‰æ‹©ä¸åŒéš”ç¦»ç­–ç•¥ï¼š

| å®¢æˆ·ç±»å‹ | éš”ç¦»ç­–ç•¥ | å‘é‡åº“å®ç° | ä¼˜ç¼ºç‚¹ |
|----------|----------|------------|--------|
| **å°å‹å®¢æˆ·** | Partition éš”ç¦» | å…±äº« Collectionï¼ŒæŒ‰ `tenant_id` åˆ†åŒº | æˆæœ¬ä½ï¼Œç®¡ç†ç®€å•ï¼›å­˜åœ¨è¿‘é‚»å¹²æ‰°é£é™© |
| **ä¸­å‹å®¢æˆ·** | Collection éš”ç¦» | æ¯ç§Ÿæˆ·ç‹¬ç«‹ Collection | éš”ç¦»æ€§å¥½ï¼›ç®¡ç†å¼€é”€ä¸­ç­‰ |
| **å¤§å‹å®¢æˆ·** | é›†ç¾¤éš”ç¦» | æ¯ç§Ÿæˆ·ç‹¬ç«‹ Cluster | å®Œå…¨éš”ç¦»ï¼Œæ€§èƒ½ç‹¬ç«‹ï¼›æˆæœ¬é«˜ |

```python
class TenantIsolationStrategy:
    """ç§Ÿæˆ·éš”ç¦»ç­–ç•¥"""
    
    def get_collection_name(self, tenant: Tenant, kb: KnowledgeBase) -> str:
        if tenant.plan == "enterprise":
            # å¤§å®¢æˆ·ï¼šç‹¬ç«‹ Collection
            return f"tenant_{tenant.id}_kb_{kb.id}"
        else:
            # å°å®¢æˆ·ï¼šå…±äº« Collectionï¼Œç”¨ partition
            return "shared_kb_collection"
    
    def get_partition_key(self, tenant: Tenant) -> str | None:
        if tenant.plan != "enterprise":
            return tenant.id
        return None
```

> å†™å…¥ä¾§è¦æ±‚ï¼šæ–‡æ¡£å…¥åº“æ—¶å¿…é¡»æºå¸¦ `tenant_id` ä¸”æ ¡éªŒ `kb_id` éš¶å±äºè¯¥ç§Ÿæˆ·ï¼Œç¦æ­¢è·¨ç§Ÿæˆ·ä¼ å…¥ KBï¼Œé¿å…è„å†™ä¸æƒé™ç»•è¿‡ã€‚

### 2.7 API å±‚å°è£…ï¼ˆå®‰å…¨å®ˆé—¨äººï¼‰

æ‰€æœ‰æ•°æ®è¯·æ±‚å¿…é¡»æµç» API å±‚ï¼Œæä¾›ç»Ÿä¸€çš„å®‰å…¨æ§åˆ¶ç‚¹ï¼š

```
ç”¨æˆ·è¯·æ±‚ â†’ APIå±‚(é‰´æƒ+æƒé™æ£€æŸ¥) â†’ ä¸šåŠ¡é€»è¾‘ â†’ æ•°æ®å±‚(å¸¦ACLè¿‡æ»¤)
                    â†“
              å®¡è®¡æ—¥å¿—è®°å½•
```

```python
@router.post("/v1/retrieve")
async def retrieve(
    request: QueryRequest,
    tenant: Tenant = Depends(get_current_tenant),
    user: User = Depends(get_current_user),
    _: None = Depends(require_permission("query:execute"))
):
    # 1. éªŒè¯ç”¨æˆ·å¯¹ç›®æ ‡çŸ¥è¯†åº“çš„è®¿é—®æƒé™
    await validate_kb_access(user, request.kb_ids)
    
    # 2. æ‰§è¡Œå¸¦å®‰å…¨ç­›é€‰çš„æ£€ç´¢
    results = await query_with_security_trimming(
        query=request.query,
        kb_ids=request.kb_ids,
        user=user,
        top_k=request.top_k
    )
    
    # 3. è®°å½•å®¡è®¡æ—¥å¿—
    await audit_log.record(
        action="retrieve",
        user=user,
        kb_ids=request.kb_ids,
        query=request.query,
        result_count=len(results)
    )
    
    return RetrieveResponse(results=results)
```

API å±‚è¿˜éœ€è¦ï¼š
- API Key/ç§Ÿæˆ·çº§é™æµä¸ç†”æ–­ï¼ˆé¿å…å•ç§Ÿæˆ·æ‹–å®æœåŠ¡ï¼‰
- API Key çš„è½®æ¢/åŠé”€æ¥å£ä¸ç¼“å­˜å¤±æ•ˆåŒæ­¥
- å¥åº·æ£€æŸ¥ä¸æ¢é’ˆï¼ˆreadiness/livenessï¼‰ï¼Œä¾¿äºéƒ¨ç½²ä¸ç›‘æ§

### 2.8 å®¡è®¡æ—¥å¿—

è®°å½•æ‰€æœ‰æ•°æ®è®¿é—®è¡Œä¸ºï¼Œä¾›åˆè§„å®¡è®¡ï¼š

```python
class AuditLog(Base):
    __tablename__ = "audit_logs"
    
    id: str
    timestamp: datetime
    tenant_id: str
    user_id: str
    action: str          # query, document:create, document:delete, etc.
    resource_type: str   # kb, document, chunk
    resource_id: str
    request_data: dict   # è¯·æ±‚å‚æ•°ï¼ˆè„±æ•ï¼‰
    response_summary: dict  # å“åº”æ‘˜è¦
    ip_address: str
    user_agent: str
```

> å®¡è®¡å­—æ®µéœ€åšè„±æ•ä¸æˆªæ–­ï¼š`request_data/response_summary` ä»…ä¿ç•™æ‘˜è¦æˆ–å“ˆå¸Œï¼Œå•æ¡å¤§å°è®¾ä¸Šé™ï¼ˆå¦‚ 1KBï¼‰ï¼›è®¾ç½®å®¡è®¡æ—¥å¿—ä¿ç•™æœŸä¸åˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…æ³„éœ²åŸå§‹ä¸šåŠ¡æ•°æ®ã€‚

### 2.9 æƒé™è®¾è®¡æ€»ç»“

| ç»´åº¦ | å®ç°æ–¹å¼ |
|------|----------|
| **è®¤è¯** | API Key / JWT / Service Account |
| **æˆæƒ** | RBAC + è‡ªå®šä¹‰è§’è‰² + æ–‡æ¡£ ACL |
| **æ•°æ®éš”ç¦»** | ç§Ÿæˆ·éš”ç¦» + çŸ¥è¯†åº“éš”ç¦» + æ–‡æ¡£çº§ ACL |
| **æ£€ç´¢å®‰å…¨** | Security Trimmingï¼ˆæ£€ç´¢æ—¶è¿‡æ»¤ï¼‰ |
| **å­˜å‚¨éš”ç¦»** | æŒ‰å®¢æˆ·è§„æ¨¡é€‰æ‹© Partition/Collection/Cluster |
| **å®¡è®¡** | å…¨é“¾è·¯è®¿é—®æ—¥å¿— |

---

## 3. API è®¾è®¡ (OpenAI å…¼å®¹)

éµå¾ª OpenAI API è§„èŒƒï¼Œæ–¹ä¾¿ä¸ç°æœ‰ç”Ÿæ€ï¼ˆLangChainã€LlamaIndexã€å„ç±» Agent æ¡†æ¶ï¼‰æ— ç¼é›†æˆã€‚

### 3.1 API æ¦‚è§ˆ

| ç±»åˆ« | API | è¯´æ˜ | OpenAI å…¼å®¹ |
|------|-----|------|-------------|
| **Chat/RAG** | `POST /v1/chat/completions` | RAG é—®ç­”ï¼ˆå…¼å®¹ OpenAI Chatï¼‰ | âœ… å…¼å®¹ |
| **RAG ç”Ÿæˆ** | `POST /v1/rag` | æ£€ç´¢ + LLM ç”Ÿæˆå›ç­” | âš¡ æ‰©å±•ï¼ˆå·²å®ç°ï¼‰ |
| **Embeddings** | `POST /v1/embeddings` | æ–‡æœ¬å‘é‡åŒ– | âœ… å…¼å®¹ |
| **æ£€ç´¢** | `POST /v1/retrieve` | çº¯æ£€ç´¢ï¼Œè¿”å›ç›¸å…³ç‰‡æ®µ | âš¡ æ‰©å±•ï¼ˆå·²å®ç°ï¼‰ |
| **çŸ¥è¯†åº“** | `POST /v1/knowledge-bases` | åˆ›å»ºçŸ¥è¯†åº“ | æ‰©å±• |
| | `GET /v1/knowledge-bases` | åˆ—è¡¨æŸ¥è¯¢ | æ‰©å±• |
| | `DELETE /v1/knowledge-bases/{kb_id}` | åˆ é™¤çŸ¥è¯†åº“ | æ‰©å±• |
| **æ–‡æ¡£** | `POST /v1/knowledge-bases/{kb_id}/documents` | ä¸Šä¼ æ–‡æ¡£ | æ‰©å±• |
| | `DELETE /v1/knowledge-bases/{kb_id}/documents/{doc_id}` | åˆ é™¤æ–‡æ¡£ | æ‰©å±• |
| **ç®¡ç†** | `POST /v1/api-keys` | åˆ›å»º API Key | æ‰©å±• |

### 3.2 è®¤è¯æ–¹å¼ (OpenAI é£æ ¼)

```http
Authorization: Bearer kb_sk_xxxxxxxxxxxxxx
```

### 3.3 Chat Completions (RAG é—®ç­”)

**å®Œå…¨å…¼å®¹ OpenAI Chat API**ï¼Œæ‰©å±• `knowledge_base_ids` å‚æ•°ï¼š

```http
POST /v1/chat/completions
Content-Type: application/json
Authorization: Bearer kb_sk_xxxxxx

{
  "model": "gpt-4o",
  "messages": [
    {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¼ä¸šçŸ¥è¯†åŠ©æ‰‹"},
    {"role": "user", "content": "ä»Šå¹´Q3çš„é”€å”®æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ"}
  ],
  "knowledge_base_ids": ["kb_sales", "kb_policy"],  // æ‰©å±•å­—æ®µ
  "temperature": 0.7,
  "stream": true
}
```

**å“åº” (éæµå¼)**ï¼š

```json
{
  "id": "chatcmpl-xxx",
  "object": "chat.completion",
  "created": 1701234567,
  "model": "gpt-4o",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "æ ¹æ®Q3é”€å”®æ”¿ç­–æ–‡æ¡£ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š\n1. ..."
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 50,
    "completion_tokens": 150,
    "total_tokens": 200
  },
  "references": [  // æ‰©å±•å­—æ®µï¼šå¼•ç”¨æ¥æº
    {
      "chunk_id": "chunk_001",
      "text": "Q3é”€å”®æ”¿ç­–è¦ç‚¹...",
      "score": 0.92,
      "metadata": {
        "kb_id": "kb_sales",
        "doc_id": "doc_001",
        "title": "2024å¹´Q3é”€å”®æ”¿ç­–",
        "page": 3
      }
    }
  ]
}
```

**å“åº” (æµå¼ SSE)**ï¼š

```
data: {"id":"chatcmpl-xxx","object":"chat.completion.chunk","choices":[{"delta":{"content":"æ ¹æ®"},"index":0}]}

data: {"id":"chatcmpl-xxx","object":"chat.completion.chunk","choices":[{"delta":{"content":"Q3é”€å”®"},"index":0}]}

data: {"id":"chatcmpl-xxx","object":"chat.completion.chunk","choices":[{"delta":{},"finish_reason":"stop","index":0}],"references":[...]}

data: [DONE]
```

### 3.4 Embeddings (å‘é‡åŒ–)

**å®Œå…¨å…¼å®¹ OpenAI Embeddings API**ï¼š

```http
POST /v1/embeddings
Content-Type: application/json
Authorization: Bearer kb_sk_xxxxxx

{
  "model": "text-embedding-3-large",
  "input": ["ä»Šå¹´Q3çš„é”€å”®æ”¿ç­–", "äº§å“å®šä»·ç­–ç•¥"]
}
```

**å“åº”**ï¼š

```json
{
  "object": "list",
  "data": [
    {
      "object": "embedding",
      "index": 0,
      "embedding": [0.0023, -0.0091, ...]
    },
    {
      "object": "embedding", 
      "index": 1,
      "embedding": [0.0041, -0.0012, ...]
    }
  ],
  "model": "text-embedding-3-large",
  "usage": {
    "prompt_tokens": 12,
    "total_tokens": 12
  }
}
```

### 3.5 Retrieve (çº¯æ£€ç´¢)

ä¸è°ƒç”¨ LLMï¼Œåªè¿”å›ç›¸å…³æ–‡æ¡£ç‰‡æ®µï¼š

```http
POST /v1/retrieve
Content-Type: application/json
Authorization: Bearer kb_sk_xxxxxx

{
  "query": "ä»Šå¹´Q3çš„é”€å”®æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ",
  "knowledge_base_ids": ["kb_sales"],
  "top_k": 5,
  "score_threshold": 0.5,
  "rerank": true
}
```

**å“åº”**ï¼š

```json
{
  "object": "list",
  "data": [
    {
      "object": "retrieval.chunk",
      "index": 0,
      "chunk_id": "chunk_001",
      "text": "Q3é”€å”®æ”¿ç­–è¦ç‚¹ï¼š1. æ–°å®¢æˆ·æŠ˜æ‰£æå‡è‡³15%...",
      "score": 0.92,
      "metadata": {
        "kb_id": "kb_sales",
        "doc_id": "doc_001",
        "title": "2024å¹´Q3é”€å”®æ”¿ç­–",
        "source": "pdf",
        "page": 3
      }
    }
  ],
  "usage": {
    "retrieval_count": 5,
    "rerank_count": 5
  }
}
```

### 3.6 RAG ç”Ÿæˆæ¥å£

æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRetrieval-Augmented Generationï¼‰ï¼Œä»çŸ¥è¯†åº“æ£€ç´¢åè°ƒç”¨ LLM ç”Ÿæˆå›ç­”ï¼š

```http
POST /v1/rag
Content-Type: application/json
Authorization: Bearer kb_sk_xxxxxx

{
  "query": "ä»Šå¹´Q3çš„é”€å”®æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ",
  "knowledge_base_ids": ["kb_sales"],
  "top_k": 5,
  "temperature": 0.7,
  "system_prompt": "ä½ æ˜¯é”€å”®æ”¿ç­–ä¸“å®¶ï¼Œè¯·ç®€æ´å›ç­”",
  "retriever_override": {
    "name": "hybrid"
  }
}
```

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `query` | string | âœ… | ç”¨æˆ·é—®é¢˜ |
| `knowledge_base_ids` | string[] | âœ… | çŸ¥è¯†åº“ ID åˆ—è¡¨ |
| `top_k` | int | | æ£€ç´¢æ•°é‡ï¼ˆé»˜è®¤ 5ï¼Œæœ€å¤§ 20ï¼‰ |
| `score_threshold` | float | | åˆ†æ•°é˜ˆå€¼ï¼ˆ0-1ï¼‰ |
| `retriever_override` | object | | ä¸´æ—¶è¦†ç›–æ£€ç´¢å™¨é…ç½® |
| `system_prompt` | string | | è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯ |
| `temperature` | float | | LLM æ¸©åº¦ï¼ˆ0-2ï¼‰ |
| `max_tokens` | int | | æœ€å¤§ç”Ÿæˆ tokenï¼ˆ1-8192ï¼‰ |
| `include_sources` | bool | | æ˜¯å¦è¿”å›æ¥æºï¼ˆé»˜è®¤ trueï¼‰ |

**å“åº”**ï¼š

```json
{
  "answer": "Q3é”€å”®æ”¿ç­–ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹è¦ç‚¹ï¼š\n\n1. **æ–°å®¢æˆ·æŠ˜æ‰£**ï¼šæå‡è‡³15%...\n2. **å¤§å®¢æˆ·æ”¿ç­–**ï¼š...",
  "sources": [
    {
      "chunk_id": "chunk_001",
      "text": "Q3é”€å”®æ”¿ç­–è¦ç‚¹ï¼š1. æ–°å®¢æˆ·æŠ˜æ‰£æå‡è‡³15%...",
      "score": 0.92,
      "knowledge_base_id": "kb_sales",
      "document_id": "doc_001",
      "metadata": {
        "title": "2024å¹´Q3é”€å”®æ”¿ç­–",
        "page": 3
      }
    }
  ],
  "model": {
    "embedding_provider": "ollama",
    "embedding_model": "bge-m3",
    "llm_provider": "ollama",
    "llm_model": "qwen3:14b",
    "retriever": "hybrid",
    "rerank_provider": null,
    "rerank_model": null
  },
  "retrieval_count": 5
}
```

**å“åº”å­—æ®µ**ï¼š

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `answer` | LLM ç”Ÿæˆçš„å›ç­” |
| `sources` | æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£ç‰‡æ®µï¼ˆå¼•ç”¨æ¥æºï¼‰ |
| `model` | ä½¿ç”¨çš„æ¨¡å‹é…ç½®ä¿¡æ¯ |
| `retrieval_count` | å®é™…æ£€ç´¢åˆ°çš„ç‰‡æ®µæ•° |

**cURL ç¤ºä¾‹**ï¼š

```bash
curl -X POST http://localhost:8020/v1/rag \
  -H "Authorization: Bearer kb_sk_xxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
    "knowledge_base_ids": ["kb_tech"],
    "top_k": 5
  }'
```

### 3.7 é”™è¯¯å“åº” (OpenAI æ ¼å¼)

```json
{
  "error": {
    "message": "Invalid API key provided",
    "type": "invalid_request_error",
    "param": null,
    "code": "invalid_api_key"
  }
}
```

### 3.7 Python SDK (OpenAI å…¼å®¹)

**å®‰è£…**ï¼š

```bash
pip install kb-service-sdk
# æˆ–ç›´æ¥ç”¨ openai åº“
pip install openai
```

**ä½¿ç”¨æ–¹å¼ 1ï¼šåŸç”Ÿ SDK**

```python
from kb_service import KBClient

client = KBClient(
    api_key="kb_sk_xxxxxx",
    base_url="https://kb.example.com/v1"
)

# åˆ›å»ºçŸ¥è¯†åº“
kb = client.knowledge_bases.create(name="é”€å”®çŸ¥è¯†åº“")

# ä¸Šä¼ æ–‡æ¡£
client.documents.create(
    knowledge_base_id=kb.id,
    file=open("sales_policy.pdf", "rb"),
    metadata={"department": "sales"}
)

# RAG é—®ç­”
response = client.chat.completions.create(
    model="gpt-4o",
    messages=[{"role": "user", "content": "Q3é”€å”®æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ"}],
    knowledge_base_ids=[kb.id],
    stream=True
)

for chunk in response:
    print(chunk.choices[0].delta.content, end="")

# çº¯æ£€ç´¢
results = client.retrieve(
    query="é”€å”®æŠ˜æ‰£",
    knowledge_base_ids=[kb.id],
    top_k=5
)
```

**ä½¿ç”¨æ–¹å¼ 2ï¼šç›´æ¥ç”¨ OpenAI SDK**

```python
from openai import OpenAI

# æŒ‡å‘æˆ‘ä»¬çš„æœåŠ¡
client = OpenAI(
    api_key="kb_sk_xxxxxx",
    base_url="https://kb.example.com/v1"
)

# å®Œå…¨å…¼å®¹ OpenAI ç”¨æ³•
response = client.chat.completions.create(
    model="gpt-4o",
    messages=[{"role": "user", "content": "Q3é”€å”®æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ"}],
    extra_body={
        "knowledge_base_ids": ["kb_sales"]  # æ‰©å±•å‚æ•°
    },
    stream=True
)

for chunk in response:
    print(chunk.choices[0].delta.content or "", end="")
```

**ä½¿ç”¨æ–¹å¼ 3ï¼šLangChain é›†æˆ**

```python
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(
    api_key="kb_sk_xxxxxx",
    base_url="https://kb.example.com/v1",
    model="gpt-4o",
    model_kwargs={
        "knowledge_base_ids": ["kb_sales"]
    }
)

response = llm.invoke("Q3é”€å”®æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ")
```

### 3.8 Ingestion å†…éƒ¨æµç¨‹

```
æ–‡æ¡£è¾“å…¥ â†’ Loader(è§£æ) â†’ Chunker(åˆ†å—) â†’ Embedder(å‘é‡åŒ–) â†’ Indexer(å…¥åº“)
```

- **Loader**ï¼šå…ˆæ”¯æŒçº¯æ–‡æœ¬ï¼Œåç»­æ‰©å±• PDF/Docx/ç½‘é¡µï¼ˆå‚è€ƒ [FastGPT][2]ï¼‰
- **Chunker**ï¼šé»˜è®¤æŒ‰é•¿åº¦åˆ†æ®µï¼Œæ”¯æŒæ»‘åŠ¨çª—å£ã€çˆ¶å­åˆ†å—
- **Embedder**ï¼šè°ƒç”¨ Embedding æ¨¡å‹ï¼ˆå¯ç”¨ `/v1/embeddings`ï¼‰
- **Indexer**ï¼šå†™å…¥å‘é‡åº“ + å¯é€‰ BM25 ç´¢å¼•

MVP å¯ä»¥å…ˆå®ç° **æ¨¡å¼ A**ï¼Œæ¨¡å¼ B ä»¥åå†åŠ ã€‚

---

## 4. Pipeline è®¾è®¡ (åŸºäº LlamaIndex)

æ ¸å¿ƒæ€æƒ³ï¼šæ¯ä¸ª Stage å¯æ’æ‹”æ›¿æ¢ï¼ŒåŸºäº LlamaIndex ç»„ä»¶è¿›è¡Œå°è£…æ‰©å±•ã€‚

### 4.1 Ingestion Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Loader  â”‚ â†’  â”‚ Chunker â”‚ â†’  â”‚ Embedder â”‚ â†’  â”‚ Indexer â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯é€‰ç®—å­**ï¼š

| Stage | ç®—å­ | è¯´æ˜ |
|-------|------|------|
| `chunker` | `simple` | æŒ‰é•¿åº¦åˆ†æ®µ |
| | `sliding_window` | æ»‘åŠ¨çª—å£ï¼Œæ”¯æŒé‡å  |
| | `parent_child` | çˆ¶å­åˆ†å—ï¼Œä¿ç•™ä¸Šä¸‹æ–‡ |
| | `semantic` | è¯­ä¹‰åˆ†å— (LlamaIndex SemanticSplitter) |
| `indexer` | `flat` | å¹³é“ºç´¢å¼• |
| | `raptor` | æ ‘å½¢ç´¢å¼• + å±‚çº§æ‘˜è¦ |
| `embedder` | `openai` | text-embedding-3-large |
| | `bge-m3` | æœ¬åœ° BGE-M3 |
| | `custom-http` | è‡ªå®šä¹‰ HTTP æ¥å£ |

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
ingestion:
  chunker:
    name: parent_child
    params: { parent_tokens: 2048, child_tokens: 512, overlap: 128 }
  indexer:
    name: raptor
    params: { depth: 3, fanout: 8 }
  embedder:
    name: openai
    params: { model: text-embedding-3-large }
```

### 4.2 Query Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QueryRewrite â”‚ â†’  â”‚ Retriever â”‚ â†’  â”‚ Reranker â”‚ â†’  â”‚ ContextBuilder â”‚ â†’  â”‚ Generator â”‚
â”‚   (å¯é€‰)      â”‚    â”‚           â”‚    â”‚  (å¯é€‰)   â”‚    â”‚                â”‚    â”‚  (å¯é€‰)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯é€‰ç®—å­**ï¼š

| Stage | ç®—å­ | è¯´æ˜ |
|-------|------|------|
| `query_rewrite` | `hyde` | HyDE å‡è®¾æ–‡æ¡£ç”Ÿæˆ |
| | `multi_query` | å¤šæŸ¥è¯¢æ‰©å±• |
| `retriever` | `dense` | çº¯å‘é‡æ£€ç´¢ |
| | `sparse` | BM25 æ£€ç´¢ |
| | `hybrid` | æ··åˆæ£€ç´¢ (RRF èåˆ) |
| `reranker` | `bge_reranker` | BGE Reranker |
| | `cohere` | Cohere Rerank API |
| `context_builder` | `simple` | ç›´æ¥æ‹¼æ¥ |
| | `parent_restore` | çˆ¶å­å—æ¢å¤ |

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
query:
  retriever:
    name: hybrid
    params: { dense_weight: 0.7, sparse_weight: 0.3, top_k: 50 }
  reranker:
    name: bge_reranker
    params: { top_k: 8 }
  context_builder:
    name: parent_restore
    params: { max_tokens: 4000 }
```

### 4.3 é¢„è®¾æ¨¡å¼ vs é«˜çº§é…ç½®

| æ¨¡å¼ | é€‚ç”¨åœºæ™¯ | é»˜è®¤ç­–ç•¥ |
|------|----------|----------|
| `default` | é€šç”¨åœºæ™¯ | simple chunker + dense retriever |
| `qa` | é—®ç­”åœºæ™¯ | parent_child chunker + hybrid retriever + reranker |
| `search` | æœç´¢åœºæ™¯ | sliding_window chunker + hybrid retriever |

åˆæœŸåªæš´éœ²é¢„è®¾æ¨¡å¼ï¼Œå¾…å¹³å°ç¨³å®šåå¼€æ”¾é«˜çº§ YAML/JSON é…ç½®ã€‚

---

## 5. ä¸æ™ºèƒ½ä½“å¹³å°é›†æˆ (OpenAI æ ‡å‡†)

ä¸¥æ ¼éµå¾ª **OpenAI API æ ‡å‡†**ï¼Œç¡®ä¿å¯æ¥å…¥ä»»ä½• Agent å¹³å°ã€‚

### 5.1 é›†æˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä»»æ„ Agent å¹³å°                                â”‚
â”‚  LangChain / LangGraph / AutoGPT / MetaGPT / FastGPT / Dify / ...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ OpenAI å…¼å®¹ API
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æœ¬é¡¹ç›® (KB-as-a-Service)                          â”‚
â”‚                                                                     â”‚
â”‚   /v1/chat/completions  â† OpenAI Chat å…¼å®¹ï¼Œè‡ªåŠ¨æ£€ç´¢çŸ¥è¯†åº“            â”‚
â”‚   /v1/embeddings        â† OpenAI Embeddings å…¼å®¹                     â”‚
â”‚   /v1/retrieve          â† çº¯æ£€ç´¢ API (ä½œä¸º Tool è°ƒç”¨)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ä¸¤ç§é›†æˆæ¨¡å¼

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **æ¨¡å¼ Aï¼šä½œä¸º LLM Provider** | Agent å¹³å°ç›´æ¥è°ƒç”¨ `/v1/chat/completions`ï¼Œæˆ‘ä»¬å†…éƒ¨å®Œæˆ RAG | ç®€å•é›†æˆï¼ŒAgent æ— æ„ŸçŸ¥ |
| **æ¨¡å¼ Bï¼šä½œä¸º Tool/Plugin** | Agent è°ƒç”¨ `/v1/retrieve` è·å–çŸ¥è¯†ï¼Œè‡ªå·±ç»„è£… prompt | çµæ´»æ§åˆ¶ï¼ŒAgent è‡ªä¸»å†³ç­– |

### 5.3 æ¨¡å¼ Aï¼šä½œä¸º LLM Provider (æ¨è)

Agent å¹³å°æŠŠæˆ‘ä»¬å½“æˆä¸€ä¸ª"å¸¦çŸ¥è¯†åº“çš„ LLM"ï¼Œåªéœ€é…ç½® `base_url`ï¼š

**LangChain**

```python
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(
    api_key="kb_sk_xxxxxx",
    base_url="https://kb.example.com/v1",  # æŒ‡å‘æˆ‘ä»¬
    model="gpt-4o",
    model_kwargs={
        "knowledge_base_ids": ["kb_sales", "kb_policy"]
    }
)

# æ­£å¸¸ä½¿ç”¨ï¼Œè‡ªåŠ¨å¸¦çŸ¥è¯†åº“æ£€ç´¢
response = llm.invoke("Q3é”€å”®æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ")
```

**LlamaIndex**

```python
from llama_index.llms.openai import OpenAI

llm = OpenAI(
    api_key="kb_sk_xxxxxx",
    api_base="https://kb.example.com/v1",
    model="gpt-4o",
    additional_kwargs={
        "knowledge_base_ids": ["kb_sales"]
    }
)
```

**AutoGPT / MetaGPT / å…¶ä»–**

åªéœ€é…ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
OPENAI_API_KEY=kb_sk_xxxxxx
OPENAI_API_BASE=https://kb.example.com/v1
```

**Dify / FastGPT ç­‰å¹³å°**

åœ¨"æ¨¡å‹ä¾›åº”å•†"ä¸­æ·»åŠ è‡ªå®šä¹‰ OpenAI å…¼å®¹æ¥å£ï¼š

```yaml
provider: openai_compatible
base_url: https://kb.example.com/v1
api_key: kb_sk_xxxxxx
model: gpt-4o
```

### 5.4 æ¨¡å¼ Bï¼šä½œä¸º Tool/Plugin

Agent æŠŠ `/v1/retrieve` æ³¨å†Œä¸ºå·¥å…·ï¼Œè‡ªå·±å†³å®šä½•æ—¶æ£€ç´¢ï¼š

**OpenAI Function Calling æ ¼å¼**

```json
{
  "type": "function",
  "function": {
    "name": "search_knowledge_base",
    "description": "æœç´¢ä¼ä¸šçŸ¥è¯†åº“ï¼Œè·å–ç›¸å…³æ–‡æ¡£ç‰‡æ®µ",
    "parameters": {
      "type": "object",
      "properties": {
        "query": {
          "type": "string",
          "description": "æœç´¢æŸ¥è¯¢è¯­å¥"
        },
        "knowledge_base_ids": {
          "type": "array",
          "items": {"type": "string"},
          "description": "è¦æœç´¢çš„çŸ¥è¯†åº“IDåˆ—è¡¨"
        },
        "top_k": {
          "type": "integer",
          "default": 5,
          "description": "è¿”å›ç»“æœæ•°é‡"
        }
      },
      "required": ["query", "knowledge_base_ids"]
    }
  }
}
```

**LangChain Tool å®šä¹‰**

```python
from langchain.tools import tool
from langchain_openai import ChatOpenAI
import httpx

@tool
def search_knowledge_base(
    query: str,
    knowledge_base_ids: list[str],
    top_k: int = 5
) -> str:
    """æœç´¢ä¼ä¸šçŸ¥è¯†åº“ï¼Œè·å–ç›¸å…³æ–‡æ¡£ç‰‡æ®µç”¨äºå›ç­”é—®é¢˜ã€‚"""
    response = httpx.post(
        "https://kb.example.com/v1/retrieve",
        headers={"Authorization": "Bearer kb_sk_xxxxxx"},
        json={
            "query": query,
            "knowledge_base_ids": knowledge_base_ids,
            "top_k": top_k
        }
    )
    return response.json()

# ç»‘å®šåˆ° Agent
from langchain.agents import create_openai_tools_agent

agent = create_openai_tools_agent(
    llm=ChatOpenAI(model="gpt-4o"),
    tools=[search_knowledge_base],
    prompt=...
)
```

**LlamaIndex Tool**

```python
from llama_index.core.tools import FunctionTool

def search_kb(query: str, kb_ids: list[str]) -> dict:
    """æœç´¢çŸ¥è¯†åº“è·å–ç›¸å…³æ–‡æ¡£"""
    # è°ƒç”¨ /v1/retrieve
    ...

search_tool = FunctionTool.from_defaults(fn=search_kb)
```

### 5.5 OpenAI Assistants API å…¼å®¹ (å¯é€‰)

å¦‚éœ€æ”¯æŒ OpenAI Assistants API é£æ ¼ï¼Œå¯å®ç°ä»¥ä¸‹æ¥å£ï¼š

```
POST /v1/assistants                 # åˆ›å»º Assistantï¼ˆç»‘å®šçŸ¥è¯†åº“ï¼‰
POST /v1/threads                    # åˆ›å»ºä¼šè¯
POST /v1/threads/{id}/messages      # å‘é€æ¶ˆæ¯
POST /v1/threads/{id}/runs          # æ‰§è¡Œå¯¹è¯
GET  /v1/threads/{id}/runs/{run_id} # è·å–ç»“æœ
```

è¿™æ ·å¯å…¼å®¹ OpenAI Assistants SDKï¼š

```python
from openai import OpenAI

client = OpenAI(
    api_key="kb_sk_xxxxxx",
    base_url="https://kb.example.com/v1"
)

# åˆ›å»ºå¸¦çŸ¥è¯†åº“çš„ Assistant
assistant = client.beta.assistants.create(
    name="é”€å”®åŠ©æ‰‹",
    model="gpt-4o",
    tools=[{"type": "retrieval"}],  # å¯ç”¨çŸ¥è¯†åº“æ£€ç´¢
    file_ids=["file_xxx"]           # æˆ– knowledge_base_ids
)
```

### 5.6 ä¸»æµ Agent å¹³å°å…¼å®¹æ€§

| å¹³å° | é›†æˆæ–¹å¼ | å…¼å®¹æ€§ |
|------|----------|--------|
| **LangChain** | ChatOpenAI + base_url | âœ… å®Œå…¨å…¼å®¹ |
| **LlamaIndex** | OpenAI LLM + api_base | âœ… å®Œå…¨å…¼å®¹ |
| **LangGraph** | åŒ LangChain | âœ… å®Œå…¨å…¼å®¹ |
| **AutoGPT** | ç¯å¢ƒå˜é‡é…ç½® | âœ… å®Œå…¨å…¼å®¹ |
| **MetaGPT** | ç¯å¢ƒå˜é‡é…ç½® | âœ… å®Œå…¨å…¼å®¹ |
| **Dify** | è‡ªå®šä¹‰æ¨¡å‹ä¾›åº”å•† | âœ… å®Œå…¨å…¼å®¹ |
| **FastGPT** | OpenAI å…¼å®¹æ¥å£ | âœ… å®Œå…¨å…¼å®¹ |
| **Coze** | è‡ªå®šä¹‰ API | âœ… å®Œå…¨å…¼å®¹ |
| **OpenAI Assistants** | å®ç° Assistants API | ğŸ”¶ å¯é€‰æ”¯æŒ |

### 5.7 è®¾è®¡åŸåˆ™

1. **é›¶ä¾µå…¥**ï¼šAgent å¹³å°æ— éœ€ä¿®æ”¹ä»£ç ï¼Œåªæ”¹é…ç½®
2. **åŒæ¨¡å¼**ï¼šæ—¢å¯ä½œä¸º LLM Providerï¼Œä¹Ÿå¯ä½œä¸º Tool
3. **æ ‡å‡†ä¼˜å…ˆ**ï¼šä¸¥æ ¼éµå¾ª OpenAI API è§„èŒƒ
4. **æ¸è¿›å¢å¼º**ï¼šæ‰©å±•å­—æ®µï¼ˆå¦‚ `knowledge_base_ids`ï¼‰ä¸å½±å“æ ‡å‡†å…¼å®¹æ€§

---

## 6. æŠ€æœ¯é€‰å‹ & é¡¹ç›®ç»“æ„

### æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|----------|------|
| **è¯­è¨€** | Python 3.11+ | ç±»å‹æ³¨è§£ã€async æ”¯æŒ |
| **Web æ¡†æ¶** | FastAPI | å†…å»º OpenAPIã€Pydanticã€ä¾èµ–æ³¨å…¥ |
| **RAG æ¡†æ¶** | LlamaIndex | Pipeline å¼•æ“æ ¸å¿ƒï¼Œç®—å­å°è£…åŸºç¡€ |
| **ORM** | SQLAlchemy 2.0 | å¼‚æ­¥æ”¯æŒï¼Œç±»å‹å®‰å…¨ |
| **æ•°æ®åº“** | PostgreSQL | å­˜å‚¨ KB/æ–‡æ¡£/é…ç½®/æ—¥å¿— |
| **å‘é‡åº“** | Milvus / Qdrant | Milvus æ‰©å±•æ€§å¼º ([DeepSearcher][1])ï¼ŒQdrant éƒ¨ç½²ç®€å• |
| **å€’æ’ç´¢å¼•** | Elasticsearch / OpenSearch | BM25 æ£€ç´¢ï¼Œæ··åˆæœç´¢ |
| **ç¼“å­˜** | Redis | ä¼šè¯ç¼“å­˜ã€API é™æµ |
| **è®¤è¯** | python-jose + passlib | JWT ç”Ÿæˆã€å¯†ç å“ˆå¸Œ |
| **Embedding** | OpenAI / BGE-M3 | å…ˆæ”¯æŒ OpenAIï¼Œåæ‰©å±•æœ¬åœ°æ¨¡å‹ |
| **LLM** | OpenAI / DeepSeek / Qwen | RAG ç”Ÿæˆ |

### ç›®å½•ç»“æ„

```text
kb-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                 # FastAPI å…¥å£
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”œâ”€â”€ tenants.py      # ç§Ÿæˆ·ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ kb.py           # çŸ¥è¯†åº“ CRUD
â”‚   â”‚   â”‚   â”œâ”€â”€ documents.py    # æ–‡æ¡£ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ query.py        # æ£€ç´¢ & RAG
â”‚   â”‚   â”‚   â””â”€â”€ admin.py        # ç®¡ç†æ¥å£
â”‚   â”‚   â””â”€â”€ deps.py             # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ api_key.py          # API Key éªŒè¯
â”‚   â”‚   â”œâ”€â”€ jwt.py              # JWT å¤„ç†
â”‚   â”‚   â”œâ”€â”€ rbac.py             # RBAC æƒé™æ§åˆ¶
â”‚   â”‚   â””â”€â”€ deps.py             # è®¤è¯ä¾èµ–
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ models/             # SQLAlchemy æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ tenant.py
â”‚   â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”‚   â”œâ”€â”€ kb.py
â”‚   â”‚   â”‚   â”œâ”€â”€ document.py
â”‚   â”‚   â”‚   â””â”€â”€ chunk.py
â”‚   â”‚   â”œâ”€â”€ schemas/            # Pydantic æ¨¡å‹
â”‚   â”‚   â””â”€â”€ services/           # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ pipeline/
â”‚   â”‚   â”œâ”€â”€ base.py             # Pipeline åŸºç±»
â”‚   â”‚   â”œâ”€â”€ registry.py         # ç®—å­æ³¨å†Œè¡¨
â”‚   â”‚   â”œâ”€â”€ ingestion.py        # Ingestion Pipeline
â”‚   â”‚   â”œâ”€â”€ query.py            # Query Pipeline
â”‚   â”‚   â””â”€â”€ operators/          # ç®—å­å®ç°
â”‚   â”‚       â”œâ”€â”€ chunkers/
â”‚   â”‚       â”œâ”€â”€ indexers/
â”‚   â”‚       â”œâ”€â”€ retrievers/
â”‚   â”‚       â”œâ”€â”€ rerankers/
â”‚   â”‚       â””â”€â”€ embedders/
â”‚   â””â”€â”€ infra/
â”‚       â”œâ”€â”€ db.py               # æ•°æ®åº“è¿æ¥
â”‚       â”œâ”€â”€ vector_store/       # å‘é‡åº“é€‚é…å™¨
â”‚       â”œâ”€â”€ storage/            # å¯¹è±¡å­˜å‚¨
â”‚       â””â”€â”€ llm/                # LLM æ¥å…¥
â”œâ”€â”€ sdk/
â”‚   â””â”€â”€ kb_client.py            # Python SDK
â”œâ”€â”€ tests/
â”œâ”€â”€ alembic/                    # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ README.md
```

---

## 7. å¼€å‘è·¯çº¿

### Phase 1ï¼šMVP (çº¦2å‘¨)

**ç›®æ ‡**ï¼šè·‘é€šæ ¸å¿ƒé“¾è·¯

- [x] é¡¹ç›®éª¨æ¶æ­å»º
  - FastAPI + PostgreSQL + SQLAlchemy 2.0
  - åŸºç¡€é…ç½®ç®¡ç† (pydantic-settings)
  - Docker Compose æœ¬åœ°å¼€å‘ç¯å¢ƒ
- [x] æ•°æ®æ¨¡å‹å®šä¹‰
  - Tenant, User, APIKey, KnowledgeBase, Document, Chunk
- [x] åŸºç¡€è®¤è¯
  - API Key ç”Ÿæˆä¸éªŒè¯
  - ç§Ÿæˆ·éš”ç¦»ä¸­é—´ä»¶
  - API Key è½®æ¢/åŠé”€èƒ½åŠ›ï¼ˆç¼“å­˜åŒæ­¥å¤±æ•ˆï¼‰
  - API Key/ç§Ÿæˆ·çº§é™æµ
- [x] æœ€ç®€ Ingestion
  - `POST /knowledge-bases/{kb_id}/documents`
  - simple chunker + å•å‘é‡åº“ï¼ˆå½“å‰ä¸ºå†…å­˜å ä½ï¼Œåç»­æ›¿æ¢ Qdrantï¼‰
  - å…¥åº“æ—¶å¼ºåˆ¶å†™å…¥ `tenant_id`ï¼Œæ ¡éªŒ `kb_id` éš¶å±å½“å‰ç§Ÿæˆ·
- [x] æœ€ç®€ Query
  - `POST /v1/retrieve` å‘é‡æ£€ç´¢ï¼Œè¿”å› top_k
- [x] Python SDK
  - `KBClient.create_kb / add_documents / query`

### Phase 1.5ï¼šç”Ÿäº§åŒ–åŸºç¡€

- [x] æ•°æ®åº“è¿ç§»
  - Alembic åŸºç¡€é…ç½®ä¸åˆå§‹è¿ç§»è„šæœ¬
- [x] å‘é‡åº“æ¥å…¥
  - Qdrant å®¢æˆ·ç«¯æ¥å…¥ï¼ŒDocker Compose å†…ç½® Qdrant æœåŠ¡
- [x] ç«¯åˆ°ç«¯æµ‹è¯•
  - e2e è¦†ç›– API Key / çŸ¥è¯†åº“ / æ–‡æ¡£å…¥åº“ / æ£€ç´¢é“¾è·¯

### Phase 2ï¼šPipeline å¯æ’æ‹” (çº¦2å‘¨)

**ç›®æ ‡**ï¼šç®—æ³•ç»„ä»¶åŒ–

- [x] Pipeline æ¡†æ¶
  - `BasePipeline` / `BaseOperator` æŠ½è±¡
  - ç®—å­æ³¨å†Œè¡¨ (Registry)
- [x] æ‰©å±• Chunker
  - sliding_window / parent_child / simpleï¼ˆé»˜è®¤ï¼‰
- [x] æ‰©å±• Retriever
  - denseï¼ˆQdrantï¼‰ / bm25ï¼ˆå†…å­˜ç‰ˆï¼‰ / hybridï¼ˆdense+bm25 åŠ æƒï¼‰
- [x] çŸ¥è¯†åº“é…ç½®
  - `config` å­—æ®µï¼šingestion / query ç­–ç•¥
  - é…ç½® APIï¼šæŸ¥çœ‹ & ä¿®æ”¹

### Phase 2.1ï¼šLlamaIndex æ¥å…¥ä¸å¤šåç«¯æ£€ç´¢

**ç›®æ ‡**ï¼šç”¨ LlamaIndex è½åœ°åˆ†å—/æ£€ç´¢ï¼Œæ¥å…¥ ES/Milvus/IVF-PQ ç­‰çœŸå®åç«¯**

- [x] ä¾èµ–ä¸é€‚é…å±‚
  - å¼•å…¥ `llama-index-core`ã€OpenAI/æœ¬åœ° embedding æ’ä»¶ï¼ˆHashEmbedding å ä½ï¼‰ï¼Œ`llama-index-vector-stores-qdrant`ã€`llama-index-retrievers-bm25`
- [x] Chunkerï¼ˆLlamaIndexï¼‰
  - é€‚é… `SentenceSplitter`/`TokenTextSplitter` â†’ ç®—å­ `llama_sentence` / `llama_token`ï¼Œå¯¹é½ `BaseChunkerOperator`ï¼ŒKB é…ç½®å¯ä¼  max_tokens/overlap
- [x] Retrieverï¼ˆLlamaIndexï¼‰
  - Denseï¼šQdrant VectorStoreIndex + Retriever (`llama_dense`)
  - BM25ï¼šLlamaIndex BM25 åŸºäºç°æœ‰ chunks (`llama_bm25`)
  - Hybridï¼šåŠ æƒèåˆ dense+bm25 (`llama_hybrid`)
- [x] Ingestion æ¥å…¥ LlamaIndex
  - chunk â†’ node â†’ embeddingï¼ˆHashEmbeddingï¼‰â†’ å†™å…¥ Qdrant + BM25
  - per-KB é…ç½®é€‰æ‹© chunker/retriever
- [x] å¤šåç«¯æ‰©å±•
  - Milvus/ES/IVF-PQ æ¥å…¥ï¼ˆå¾…åŠï¼‰ï¼šæ·»åŠ å¯¹åº” vector store/retriever é€‚é…å™¨ä¸ KB é…ç½®ï¼ˆstore ç±»å‹ã€index å‚æ•°ï¼‰
- [x] é…ç½®æ ¡éªŒä¸ API
  - KB `config` å¢åŠ  store/embedding/retriever/params æ ¡éªŒï¼Œé”™è¯¯é…ç½®æå‰æŠ¥é”™
- [x] å›å½’æµ‹è¯•
  - e2e è¦†ç›– dense/BM25/hybridï¼ˆä½¿ç”¨ HashEmbedding/Qdrant å†…ç½®ï¼‰ï¼Œç«¯å£ 8020 é€šè¿‡
- [x] å·²ä¼˜åŒ–
  - ~~å¤š KB é…ç½®ï¼šæ£€ç´¢æ—¶ä»…å–ç¬¬ä¸€ä¸ª KB çš„é…ç½®~~ â†’ å·²å®ç° `_validate_retriever_config` å†²çªæ ¡éªŒ
  - ~~llama_dense è¿‡æ»¤ï¼šæ”¹ä¸ºæ£€ç´¢æ—¶æºå¸¦ kb_id filter~~ â†’ å·²ä½¿ç”¨ LlamaIndex MetadataFilters å®ç°
  - ~~Hybrid æ¥æºæ ‡è®°ï¼šä¸º hit å¢åŠ  source å­—æ®µ~~ â†’ å·²å®ç°
  - ~~LlamaIndex BM25 ç¼“å­˜ï¼šå®ä¾‹çº§ç¼“å­˜è·¨è¯·æ±‚ä¸å…±äº«~~ â†’ å·²å®ç°å…¨å±€ç¼“å­˜ç®¡ç†å™¨ `app/infra/bm25_cache.py`
  - ~~å¤šåç«¯å†™å…¥ï¼šMilvus/ES å†™å…¥å¤±è´¥åªæ‰“å°æ—¥å¿—~~ â†’ å·²å®ç°ç»“æ„åŒ–è¿”å› `IngestionResult`/`IndexingResult`

### Phase 3ï¼šæƒé™ & é«˜çº§èƒ½åŠ› (çº¦3å‘¨)

**ç›®æ ‡**ï¼šä¼ä¸šçº§åŠŸèƒ½

- [ ] å®Œæ•´æƒé™ç³»ç»Ÿ
  - RBAC å†…ç½®è§’è‰² + è‡ªå®šä¹‰è§’è‰²
  - çŸ¥è¯†åº“çº§åˆ«æƒé™æ§åˆ¶
  - **æ–‡æ¡£çº§ ACL æƒé™** (allow_users/roles/groups)
  - **æ•æ„Ÿåº¦çº§åˆ«** (public/internal/confidential/secret)
  - JWT ç”¨æˆ·è®¤è¯
- [ ] Security Trimming
  - æ£€ç´¢æ—¶è‡ªåŠ¨æ³¨å…¥ ACL è¿‡æ»¤
  - å‘é‡åº“ metadata filter å®ç°
  - äºŒæ¬¡å®‰å…¨ä¿®æ•´é€»è¾‘
- [ ] å¤šç§Ÿæˆ·å­˜å‚¨éš”ç¦»
  - Partition éš”ç¦»ï¼ˆå°å®¢æˆ·ï¼‰
  - Collection éš”ç¦»ï¼ˆä¸­å¤§å®¢æˆ·ï¼‰
  - éš”ç¦»ç­–ç•¥è‡ªåŠ¨é€‰æ‹©
- [x] å¯è§‚æµ‹æ€§ - ç»“æ„åŒ–æ—¥å¿— & è¯·æ±‚è¿½è¸ª âœ…
  - `app/infra/logging.py`ï¼šJSON æ ¼å¼æ—¥å¿—ï¼ˆç”Ÿäº§ï¼‰/ å½©è‰²æ§åˆ¶å°ï¼ˆå¼€å‘ï¼‰
  - `app/middleware/request_trace.py`ï¼šè¯·æ±‚è¿½è¸ªä¸­é—´ä»¶
  - `X-Request-ID` / `X-Response-Time` å“åº”å¤´
  - è¯·æ±‚ä¸Šä¸‹æ–‡å˜é‡ï¼ˆrequest_id, tenant_idï¼‰
  - `LOG_LEVEL` / `LOG_JSON` ç¯å¢ƒå˜é‡é…ç½®
- [x] å®¡è®¡æ—¥å¿— âœ…
  - `app/models/audit_log.py`ï¼šå®¡è®¡æ—¥å¿—æ•°æ®æ¨¡å‹
  - `app/services/audit.py`ï¼šå®¡è®¡æœåŠ¡ï¼ˆè®°å½• + æŸ¥è¯¢ + ç»Ÿè®¡ï¼‰
  - è®°å½•ï¼šrequest_id, tenant_id, action, method, path, status_code, duration_ms
  - æ”¯æŒæ•æ„Ÿä¿¡æ¯è„±æ•
  - æŒ‰ç§Ÿæˆ·/æ—¶é—´/æ“ä½œç±»å‹æŸ¥è¯¢
- [x] Reranker é›†æˆ âœ…
  - æ£€ç´¢æ¥å£æ–°å¢ `rerank` å’Œ `rerank_top_k` å‚æ•°
  - æ”¯æŒå¤šæä¾›å•†ï¼ˆOllama/Cohere/æ™ºè°±/SiliconFlowï¼‰
  - `fusion` æ£€ç´¢å™¨å†…ç½® Rerank æ”¯æŒ
  - æœåŠ¡å±‚åå¤„ç† + ç»“æœ source æ ‡è®°
- [ ] é«˜çº§ Pipeline
  - çˆ¶å­åˆ†å— + RAPTOR Indexer
- [x] RAG ç”Ÿæˆ âœ…
  - `POST /v1/rag` æ¥å£å·²å®ç°
  - æ”¯æŒå¤š LLM æä¾›å•†ï¼ˆOllama/OpenAI/Gemini/Qwen/DeepSeek ç­‰ï¼‰
  - å¯é…ç½®æ£€ç´¢å™¨/ç³»ç»Ÿæç¤ºè¯/æ¸©åº¦/æœ€å¤§token
  - è¿”å›å¼•ç”¨æ¥æºå’Œæ¨¡å‹ä¿¡æ¯
- [x] æœåŠ¡å±‚å‚æ•°æ¨¡å‹é‡æ„ âœ…
  - æ–°å¢ `app/schemas/internal.py`ï¼šæœåŠ¡å±‚å†…éƒ¨å‚æ•° Pydantic Schema
  - `RAGParams`ï¼šRAG ç”Ÿæˆå‚æ•°ï¼ˆæ£€ç´¢ + LLM é…ç½®ï¼‰
  - `RetrieveParams`ï¼šæ£€ç´¢å‚æ•°ï¼ˆquery, top_k, score_threshold, metadata_filter, retriever_override, context_windowï¼‰
  - `IngestionParams`ï¼šæ–‡æ¡£æ‘„å–å‚æ•°ï¼ˆtitle, content, metadata, source, generate_doc_summary, enrich_chunksï¼‰
  - `RetryChunksParams`ï¼šé‡è¯•å¤±è´¥ chunks å‚æ•°
  - æœåŠ¡å±‚ä¸ API Schema è§£è€¦ï¼Œå‚æ•°éªŒè¯æ›´ä¸¥æ ¼
- [ ] å¯è§‚æµ‹æ€§
  - è°ƒç”¨æ—¥å¿— & Trace
  - æ£€ç´¢è´¨é‡æŒ‡æ ‡

### Phase 4ï¼šç”Ÿäº§å°±ç»ª (çº¦2å‘¨)

**ç›®æ ‡**ï¼šå¯éƒ¨ç½²ä¸Šçº¿

- [ ] æ€§èƒ½ä¼˜åŒ–
  - å¼‚æ­¥æ‰¹é‡å¤„ç†
  - è¿æ¥æ± ä¼˜åŒ–
- [ ] è¿ç»´èƒ½åŠ›
  - å¥åº·æ£€æŸ¥ / Metrics
  - é…ç½®çƒ­æ›´æ–°
- [ ] æ–‡æ¡£å®Œå–„
  - API æ–‡æ¡£ (OpenAPI)
  - éƒ¨ç½²æ–‡æ¡£
  - SDK ä½¿ç”¨æŒ‡å—

---

### é‡Œç¨‹ç¢‘æ€»ç»“

å®Œæˆåä½ å°†æ‹¥æœ‰ï¼š

- âœ… å¤šç§Ÿæˆ·ã€å¤šçŸ¥è¯†åº“ã€æƒé™éš”ç¦»çš„ä¼ä¸šçº§æœåŠ¡
- âœ… å¯æ’æ‹”çš„ RAG Pipelineï¼ŒåŸºäº LlamaIndex æ‰©å±•
- âœ… HTTP API + Python SDKï¼Œä¸æ™ºèƒ½ä½“å¹³å°è§£è€¦
- âœ… ç”Ÿäº§å¯ç”¨çš„å¯è§‚æµ‹æ€§å’Œè¿ç»´èƒ½åŠ›

---

## 8. ä¸‹ä¸€æ­¥

å‡†å¤‡å¼€å§‹å¼€å‘ï¼Œå»ºè®®ä» Phase 1 çš„é¡¹ç›®éª¨æ¶å¼€å§‹ã€‚

[1]: https://github.com/zilliztech/deep-searcher?utm_source=chatgpt.com "GitHub - zilliztech/deep-searcher: Open Source Deep Research ..."
[2]: https://github.com/labring/FastGPT?utm_source=chatgpt.com "GitHub - labring/FastGPT: FastGPT is a knowledge-based platform built ..."
[3]: https://github.com/SciPhi-AI/R2R?utm_source=chatgpt.com "GitHub - SciPhi-AI/R2R: SoTA production-ready AI retrieval system ..."
[4]: https://github.com/JoshuaC215/agent-service-toolkit?utm_source=chatgpt.com "JoshuaC215/agent-service-toolkit - GitHub"
