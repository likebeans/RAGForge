# 前端功能文档

## Ground 实验页面功能

### 知识库管理增强

Ground 实验页面 (`/compare/[id]`) 支持灵活的知识库管理：

#### 1. 配置变更检测

当切分/索引相关配置发生变化时，系统会自动检测并提示用户需要重新入库：

**监控的配置项**：
- 切分器类型 (`chunker`) 及参数 (`chunkerParams`)
- 索引器类型 (`indexer`) 及参数 (`indexerParams`)
- 增强器类型 (`enricher`) 及参数 (`enricherParams`)

**工作流程**：
1. 用户入库文档时，系统保存当前配置快照 (`ingestedConfig`)
2. 用户修改上述任何配置后，系统比较当前配置与快照
3. 如检测到变化，显示 toast 提示并清除入库状态

```tsx
// 配置变更检测逻辑示例
useEffect(() => {
  if (!ingestedConfig || !ingestedKbId) return;
  
  const hasChanged = 
    ingestedConfig.chunker !== selectedChunker ||
    JSON.stringify(ingestedConfig.chunkerParams) !== JSON.stringify(chunkerParams) ||
    // ... 其他配置比较
  
  if (hasChanged) {
    toast.warning(`配置已变更，需要重新入库`);
    setIngestedKbId(null);
    setIngestedConfig(null);
  }
}, [selectedChunker, chunkerParams, selectedIndexer, ...]);
```

#### 2. 选择已有知识库

用户可以选择已有的知识库进行检索测试，无需重新入库：

**UI 组件**：
- **选择知识库按钮**：位于检索设置区域，点击打开知识库列表
- **可点击 Badge**：已入库状态的绿色 Badge 可点击更换知识库
- **知识库选择 Dialog**：显示所有可用知识库，支持选择切换

**状态变量**：
```tsx
// 知识库选择器相关状态
const [kbSelectorOpen, setKbSelectorOpen] = useState(false);
const [knowledgeBases, setKnowledgeBases] = useState<KnowledgeBase[]>([]);
const [isLoadingKbs, setIsLoadingKbs] = useState(false);
```

**API 调用**：
```tsx
// 加载知识库列表
const loadKnowledgeBases = async () => {
  const res = await client.listKnowledgeBases();
  setKnowledgeBases(res.items);
};

// 选择知识库
const handleSelectKnowledgeBase = (kb: KnowledgeBase) => {
  setIngestedKbId(kb.id);
  setIngestedKbName(kb.name);
  setIngestedConfig({...}); // 保存当前配置快照
  setKbSelectorOpen(false);
};
```

**使用场景**：
- 复用已有知识库进行检索测试
- 切换不同知识库对比检索效果
- 无需重复入库即可测试

#### 3. 智能检索器联动

根据切分器和索引器类型，自动联动相关检索器：

| 切分器/索引器 | 自动切换检索器 |
|--------------|---------------|
| `parent_child` | `parent_document` |
| `raptor` | `raptor` |

```tsx
// 联动逻辑示例
useEffect(() => {
  if (selectedChunker === "parent_child" && selectedRetriever !== "parent_document") {
    setSelectedRetriever("parent_document");
  }
  if (selectedIndexer === "raptor" && selectedRetriever !== "raptor") {
    setSelectedRetriever("raptor");
  }
}, [selectedChunker, selectedIndexer]);
```

### 多 Pipeline 管理

Ground 实验页面支持创建和管理多个 Pipeline 配置（最多 4 个），方便对比不同分段/检索策略的效果。

#### 1. Pipeline 类型定义

```typescript
type PipelineConfig = {
  id: string;
  name: string;                    // 显示名称: "1", "2", "3", "4"
  // 分段配置
  chunker: string;
  chunkerParams: Record<string, unknown>;
  // 索引配置
  indexer: string;
  indexerParams: Record<string, unknown>;
  // 增强配置
  enricher: string;
  enricherParams: Record<string, unknown>;
  // 检索配置
  retriever: string;
  retrieverParams: Record<string, unknown>;
  topK: number;
  // 模型配置
  embedProvider: string;
  embedModel: string;
  // 入库状态
  ingestedKbId: string | null;
  ingestedKbName: string;
  isIngesting: boolean;
};
```

#### 2. UI 布局

Pipeline 按钮位于标题栏 Ground 名称后方：

```
← | ground-xxx | [1] [2] [+] [×] | 检索对比 | 保存到知识库
     ↑ 返回       ↑ Pipeline 按钮     ↑ 操作按钮
```

- **数字按钮 (1-4)**：切换 Pipeline，当前选中高亮，已入库的显示绿色圆点
- **+ 按钮**：创建新 Pipeline（最多 4 个）
- **× 按钮**：删除当前 Pipeline（至少保留 1 个）

#### 3. 配置持久化

Pipeline 配置通过 localStorage 持久化，下次进入同一 Ground 自动加载：

**存储 Key**：`ground_pipelines_${groundId}`

```typescript
// 加载 Pipeline 配置
useEffect(() => {
  if (!groundId || pipelinesLoaded) return;
  const saved = localStorage.getItem(`ground_pipelines_${groundId}`);
  if (saved) {
    const savedPipelines = JSON.parse(saved);
    setPipelines(savedPipelines);
    // 恢复第一个 Pipeline 的配置到 UI
    const firstPipeline = savedPipelines[0];
    setSelectedChunker(firstPipeline.chunker);
    // ... 恢复其他配置
  }
  setPipelinesLoaded(true);
}, [groundId, pipelinesLoaded]);

// 保存 Pipeline 配置
useEffect(() => {
  if (!groundId || !pipelinesLoaded) return;
  localStorage.setItem(`ground_pipelines_${groundId}`, JSON.stringify(pipelines));
}, [pipelines, groundId, pipelinesLoaded]);
```

#### 4. Pipeline 切换逻辑

切换 Pipeline 时，自动保存当前配置并恢复目标 Pipeline 配置：

```typescript
const switchPipeline = (index: number) => {
  if (index === currentPipelineIndex) return;
  // 保存当前配置
  updateCurrentPipeline({ chunker: selectedChunker, ... });
  // 切换索引
  setCurrentPipelineIndex(index);
  // 恢复目标配置到 UI
  const target = pipelines[index];
  setSelectedChunker(target.chunker);
  // ...
};
```

#### 5. 检索对比联动

点击「检索对比」按钮时，自动传递所有已入库的知识库 ID：

```typescript
// 获取所有已入库的知识库 ID
const getIngestedKbIds = () => {
  return pipelines
    .filter(p => p.ingestedKbId)
    .map(p => p.ingestedKbId);
};

// 跳转时带上 kbs 参数
router.push(`/retrieval-compare?ground=${groundId}&kbs=${kbIds.join(",")}`);
```

#### 6. 检索对比页自动加载

检索对比页面 (`/retrieval-compare`) 支持从 URL 参数自动加载知识库：

**URL 参数**：
- `ground`: Ground ID
- `kbs`: 逗号分隔的知识库 ID 列表

```typescript
// 自动加载知识库到对比槽位
useEffect(() => {
  if (!kbsParam || autoLoaded) return;
  const kbIds = kbsParam.split(",");
  // 加载知识库列表并匹配
  const matchedKbs = kbIds.map(id => knowledgeBases.find(kb => kb.id === id));
  // 创建对应的对比槽位
  const newSlots = matchedKbs.map((kb, i) => ({
    id: `slot-${i + 1}`,
    kbId: kb.id,
    kbName: kb.name,
    retriever: "hybrid",
    // ...
  }));
  setCompareSlots(newSlots);
  toast.success(`已自动加载 ${matchedKbs.length} 个知识库`);
}, [kbsParam, autoLoaded]);
```

#### 7. 使用流程

1. 在 Ground 详情页创建第一个 Pipeline，配置分段/检索参数
2. 点击「入库」将文档入库到知识库
3. 点击 **+** 创建新 Pipeline，配置不同参数后入库
4. 重复步骤 2-3，最多创建 4 个 Pipeline
5. 点击「检索对比」按钮，自动跳转并加载所有已入库的知识库
6. 在检索对比页面输入查询，对比不同 Pipeline 的检索效果
7. 点击「结束对比」按钮，选择保留效果最好的知识库，清理其他临时资源

#### 8. 结束对比功能

在检索对比页面，点击「结束对比」按钮可以清理实验资源：

**UI 位置**：顶部导航栏，"添加对比"按钮左侧（仅在关联 Playground 时显示）

**功能流程**：
1. 弹出 Dialog 显示当前对比中的所有知识库
2. 点击知识库卡片切换保留/删除状态（绿色=保留，红色=删除）
3. 默认全部保留，用户可以选择只保留效果最好的
4. 点击「确认结束」执行清理操作
5. 自动跳转到知识库列表页

**清理内容**：
- 删除未选中保留的知识库
- 删除 Pipeline 中已入库但未选中保留的知识库
- 清除 localStorage 中的 Pipeline 配置
- 删除 Ground 实验本身

```typescript
// 结束对比执行逻辑
const executeEndCompare = async () => {
  const allKbs = getCompareKbs();
  const kbsToDelete = allKbs.filter(kb => !kbsToKeep.includes(kb.id));
  
  // 删除不保留的知识库
  for (const kb of kbsToDelete) {
    await client.deleteKnowledgeBase(kb.id);
  }
  
  // 清除 localStorage 中的 Pipeline 配置
  localStorage.removeItem(`ground_pipelines_${groundId}`);
  
  // 删除 Ground
  await client.deleteGround(groundId);
  
  router.push("/knowledge-bases");
};
```

#### 9. Ground 删除联动

在 Ground 列表页删除 Ground 时，会同时删除所有关联的知识库：

```typescript
// 删除 Ground 时的清理逻辑
const deleteGround = async (groundId: string) => {
  // 从 localStorage 读取 Pipeline 配置
  const pipelinesKey = `ground_pipelines_${groundId}`;
  const savedPipelines = localStorage.getItem(pipelinesKey);
  
  if (savedPipelines) {
    const pipelines = JSON.parse(savedPipelines);
    // 删除所有已入库的知识库
    for (const p of pipelines) {
      if (p.ingestedKbId) {
        await client.deleteKnowledgeBase(p.ingestedKbId);
      }
    }
    // 清除 localStorage
    localStorage.removeItem(pipelinesKey);
  }
  
  // 删除 Ground 本身
  await client.deleteGround(groundId);
};
```

#### 10. 知识库批量删除

在知识库列表页支持批量选择和删除：

**UI 位置**：知识库卡片网格上方的批量操作栏

**功能流程**：
1. 卡片左上角显示选择框（hover 或已选中时可见）
2. 点击选择框切换知识库选中状态
3. 操作栏显示全选/取消全选按钮和已选数量
4. 点击「批量删除」按钮打开确认对话框
5. 确认后依次删除选中的知识库

```typescript
// 批量删除执行逻辑
const confirmBatchDelete = async () => {
  if (!client || selectedKbs.length === 0) return;
  
  setIsBatchDeleting(true);
  let successCount = 0;
  let failCount = 0;
  
  for (const kbId of selectedKbs) {
    try {
      await client.deleteKnowledgeBase(kbId);
      successCount++;
    } catch {
      failCount++;
    }
  }
  
  toast.success(`成功删除 ${successCount} 个知识库`);
  setSelectedKbs([]);
  refreshKnowledgeBases();
};
```

### 检索结果详情

检索结果支持详情弹窗查看：

**普通检索模式**：
- 显示分段序号、文件名
- 显示评分标签（精确匹配 / 高相关 / 中相关 / 低相关）
- 全文内容展示

**父子检索模式**：
- 左侧：父块内容
- 右侧：匹配的子块列表，高亮显示
- 支持大尺寸 Dialog（98vw x 90vh）

```tsx
// 判断是否为父子检索结果
const isParentChildResult = (hit: ChunkHit) => {
  return hit.context_text || (hit.children && hit.children.length > 0);
};
```

## 状态持久化

Ground 页面设置通过 localStorage 持久化：

**存储 Key**：`ground-settings-{groundId}`

**持久化内容**：
- 切分器配置 (`chunker`, `chunkerParams`)
- 检索器配置 (`retriever`, `retrieverParams`, `topK`)
- 增强器配置 (`enricher`, `enricherParams`)
- 索引器配置 (`indexer`, `indexerParams`)
- 模型配置 (`embedProvider`, `embedModel`)
- 入库状态 (`ingestedKbId`, `ingestedKbName`)
- 选中文档 (`selectedDocId`)

## 知识库详情页配置功能

### 基础信息展示

知识库配置页面 (`/knowledge-bases/[id]` → 配置标签页) 在基础信息卡片中展示以下内容：

#### 1. 分段设置（只读）

显示知识库入库时使用的分段配置：
- **切分器类型**：以 Badge 形式显示
- **参数详情**：键值对列表展示

如未配置，显示「未配置（将使用默认设置）」提示。

#### 2. 索引增强设置（只读）

显示索引器和增强器配置：
- **索引器 (Indexer)**：类型和参数
- **增强器 (Enricher)**：类型和参数

如未配置，显示「未配置」提示。

#### 3. 全局默认模型

展示项目级别的默认模型配置，读取自全局状态 (`defaultModels`)：

| 模型类型 | 说明 |
|---------|------|
| LLM | 大语言模型，用于 RAG 生成、HyDE 等 |
| Embedding | 嵌入模型，用于文档向量化 |
| Rerank | 重排模型，用于检索结果优化 |

**数据来源**：
- 全局状态 `useAppStore().defaultModels`
- 可在主导航「设置」中配置

**UI 展示**：
```tsx
// 从全局状态读取默认模型
const { defaultModels } = useAppStore();

// 展示格式：provider / model
{defaultModels.llm ? `${defaultModels.llm.provider} / ${defaultModels.llm.model}` : "未设置"}
```

**说明**：
- 显示当前全局默认的 LLM / Embedding / Rerank 模型配置
- 所有需要使用模型的功能（入库、检索等）默认使用这些模型
- 点击问号图标可查看配置提示

### 相关类型定义

```typescript
// KnowledgeBase 配置结构
interface KnowledgeBaseConfig {
  chunking?: {
    method?: string;
    params?: Record<string, unknown>;
  };
  indexer?: {
    method?: string;
    params?: Record<string, unknown>;
  };
  enricher?: {
    method?: string;
    params?: Record<string, unknown>;
  };
  embedding_provider?: string;
  embedding_model?: string;
}
```

## API 连接自动重试机制

### 问题背景

后端服务在空闲一段时间后，数据库连接池会关闭。首次请求需要重建连接（约 400-500ms），期间可能导致前端连接失败。

### 解决方案

在 `autoConnect` 方法中实现带重试的健康检查，解决后端连接池冷启动问题：

```typescript
// /frontend/src/lib/store.ts

// 带重试的健康检查
const healthCheckWithRetry = async (maxRetries = 2, delay = 500): Promise<boolean> => {
  for (let i = 0; i <= maxRetries; i++) {
    try {
      await newClient.health();
      return true;
    } catch {
      if (i < maxRetries) {
        // 等待后重试
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }
  return false;
};
```

### 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `maxRetries` | 2 | 最大重试次数（总共尝试 3 次） |
| `delay` | 500ms | 每次重试间隔 |

### 工作流程

1. 页面加载时，`autoConnect` 自动执行
2. 首次健康检查失败后，等待 500ms 重试
3. 最多重试 2 次（总共 3 次尝试）
4. 任意一次成功则设置 `isConnected: true`
5. 全部失败则保持 `isConnected: false`

## 相关文件

- `/frontend/src/app/(main)/compare/[id]/page.tsx` - Ground 实验页面主组件
- `/frontend/src/app/(main)/knowledge-bases/[id]/page.tsx` - 知识库详情页面主组件
- `/frontend/src/lib/api.ts` - API 客户端（包含 `KnowledgeBase`、`KnowledgeBaseConfig` 类型定义）
- `/frontend/src/lib/store.ts` - 全局状态管理（包含 `defaultModels` 状态、`autoConnect` 自动重连逻辑）
