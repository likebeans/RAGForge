# 前端功能测试清单

## 测试前置条件

1. 后端服务运行在 `http://localhost:8020`
2. 已配置有效的 API Key
3. 至少创建一个知识库并上传文档

**启动前端**：
```bash
cd /home/admin1/work/self_rag_pipeline/frontend
npm run dev
```

访问 `http://localhost:3000` 开始测试。

---

## 1. 基础布局与主题

| 功能 | 路径/位置 | 测试内容 | 结果 |
|------|----------|---------|------|
| 侧边栏折叠 | 左侧 Sidebar | 点击折叠/展开按钮 | ⬜ |
| 移动端菜单 | Header 左侧汉堡按钮 | 窄屏下显示移动端侧边栏 | ⬜ |
| 主题切换 | Header 右上角太阳/月亮图标 | 深色/浅色模式切换 | ⬜ |
| 导航跳转 | Sidebar 导航项 | 点击跳转到对应页面 | ⬜ |

---

## 2. 设置页 `/settings`

| 功能 | 测试内容 | 结果 |
|------|---------|------|
| API Base 配置 | 输入并保存 API 地址 | ⬜ |
| API Key 配置 | 输入并保存 API Key | ⬜ |
| 连接测试 | 点击"测试连接"按钮 | ⬜ |
| 连接状态显示 | 成功/失败状态展示 | ⬜ |
| **API Key 管理** (admin) | 列出所有 API Keys | ⬜ |
| **创建 API Key** (admin) | 选择角色创建新 Key | ⬜ |
| **删除 API Key** (admin) | 删除现有 Key | ⬜ |
| **复制新 Key** (admin) | 创建后复制到剪贴板 | ⬜ |

---

## 3. 聊天页 `/chat`

| 功能 | 测试内容 | 结果 |
|------|---------|------|
| 发送消息 | 输入框输入并发送 | ⬜ |
| 流式响应 | 回答逐字流式显示 | ⬜ |
| Markdown 渲染 | 代码块、列表、粗体等 | ⬜ |
| 来源引用展示 | 展开/折叠来源面板 | ⬜ |
| 知识库选择 | 下拉选择目标知识库 | ⬜ |
| 检索器选择 | 下拉选择检索器类型 | ⬜ |
| 新建对话 | 点击"新建对话"按钮 | ⬜ |
| 对话历史列表 | Sidebar 显示历史对话 | ⬜ |
| 切换对话 | 点击历史对话切换 | ⬜ |
| 删除对话 | 悬停显示删除按钮 | ⬜ |

---

## 4. 知识库管理 `/knowledge-bases`

| 功能 | 测试内容 | 结果 |
|------|---------|------|
| 知识库列表 | 卡片式展示所有知识库 | ⬜ |
| 创建知识库 | 填写名称/描述创建 | ⬜ |
| 删除知识库 | 点击删除按钮 | ⬜ |
| 进入详情 | 点击卡片进入详情页 | ⬜ |
| 刷新列表 | 点击刷新按钮 | ⬜ |

---

## 5. 知识库详情 `/knowledge-bases/[id]`

| 功能 | 测试内容 | 结果 |
|------|---------|------|
| 文档列表 | 表格展示所有文档 | ⬜ |
| 文件上传 | 拖拽或点击上传文件 | ⬜ |
| 文本上传 | 点击"粘贴文本"弹窗上传 | ⬜ |
| 上传进度 | 显示上传百分比 | ⬜ |
| 删除文档 | 点击删除按钮 | ⬜ |
| 返回列表 | 点击返回箭头 | ⬜ |

---

## 6. 检索对比 `/compare`

| 功能 | 测试内容 | 结果 |
|------|---------|------|
| 多检索器对比 | 选择多个检索器同时查询 | ⬜ |
| 结果并排展示 | 各检索器结果分列显示 | ⬜ |
| 评分展示 | 显示检索评分 | ⬜ |

---

## 测试结果汇总

| 模块 | 通过 | 失败 | 备注 |
|------|------|------|------|
| 基础布局与主题 | | | |
| 设置页 | | | |
| 聊天页 | | | |
| 知识库管理 | | | |
| 知识库详情 | | | |
| 检索对比 | | | |

---

## 问题记录

### 问题 1 - 对话列表未接后台
- **模块**：`chat/page.tsx` + `sidebar.tsx`
- **描述**：新建对话按钮只清空 currentConversationId，不调用 createNewConversation API；聊天页也不读取 currentConversationId 或加载/保存消息，历史对话只在内存里切 ID。刷新后全丢失。
- **修复方案**：新建对话时调用 API 创建，聊天页加载对话消息，发送消息后保存到后端
- **修复状态**：✅ 已修复

### 问题 1.1 - 首次发送消息需要两次才能开始对话
- **模块**：`chat/page.tsx`
- **描述**：输入第一条消息时，会先创建聊天历史记录，但 `createNewConversation` 更新 `currentConversationId` 后触发 `useEffect` 加载消息，导致本地消息被清空，需要再次输入才能开始对话。
- **修复方案**：添加 `isCreatingConversationRef` 标记，创建对话时设置为 true，`useEffect` 检测到此标记时跳过加载消息
- **修复状态**：✅ 已修复

### 问题 1.2 - 对话消息未保存到数据库
- **模块**：`chat/page.tsx`
- **描述**：切换对话历史记录后再切换回去，聊天记录消失。因为消息只在前端内存中，未保存到后端数据库。每个对话可能有不同配置（知识库、检索方式等），需要持久化。
- **修复方案**：发送用户消息时调用 `client.addMessage()` 保存到后端；流式响应完成后调用 `client.addMessage()` 保存助手消息（包含 retriever 和 sources）
- **修复状态**：✅ 已修复

### 问题 1.3 - 对话 URL 缺少 ID 参数
- **模块**：`chat/page.tsx`, `sidebar.tsx`
- **描述**：对话 URL 没有包含对话 ID（如 `/chat/xxx`），导致刷新页面后无法恢复到当前对话，也无法分享对话链接。
- **修复方案**：
  1. 创建共享组件 `components/chat/chat-view.tsx`
  2. 添加动态路由 `/chat/[id]/page.tsx` 处理已有对话
  3. 简化 `/chat/page.tsx` 为新对话入口
  4. 首次发送消息后重定向到 `/chat/{id}`
  5. sidebar 使用 `router.push("/chat/{id}")` 导航
- **修复状态**：✅ 已修复

### 问题 2 - 设置页测试连接逻辑问题
- **模块**：`settings/page.tsx`
- **描述**："测试连接"用局部 base/key 探活，但无论是否点击"保存"都会把全局 isConnected 置 true/false，不同步更新 store 客户端。用户用新 Key 测试成功但未保存时，其他页面仍用旧凭据却显示"已连接"。
- **修复方案**：测试成功后自动保存配置并重建 client
- **修复状态**：✅ 已修复

### 问题 3 - SSE 解析忽略 event 类型
- **模块**：`api.ts` streamRAG
- **描述**：SSE 解析忽略 event: 类型，所有 data: 都被当作内容/来源；event: done/error 或 [DONE] 会被拼进回答，只有连接关闭才触发 onDone。
- **修复方案**：记录 eventType 并对 done/error 显式处理
- **修复状态**：✅ 已修复

### 问题 4 - abortRef 未使用/清理
- **模块**：`chat/page.tsx`
- **描述**：abortRef 从未使用/清理；新提问或路由切换时旧的流式请求仍跑着并尝试 setState，浪费资源也可能触发内存泄漏警告。
- **修复方案**：启动新请求前 abort 旧 controller，组件卸载时清理
- **修复状态**：✅ 已修复

### 问题 5 - Header 菜单空操作
- **模块**：`header.tsx`
- **描述**：头部菜单的"设置/断开连接"是空操作，无法从头部跳转设置，也不能清理凭据。
- **修复方案**：绑定 router 跳转设置页，断开时清空 key/connection 标记
- **修复状态**：✅ 已修复

---

## 优化建议

1. 考虑添加虚拟列表优化长对话性能
2. 添加消息重试/编辑功能
3. 添加导出对话历史功能 
